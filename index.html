<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <script src="jquery-2.1.1.js"></script>
        <script src="statkart.js"></script>
        <script type="text/javascript" src="proj4js-compressed.js"></script>
       <script type="text/javascript" src="http://openlayers.org/api/OpenLayers.js"></script>
       <script type="text/javascript" src="utm2latlon.js"></script>
       <link rel="stylesheet" type="text/css" href="stylePreview.css">
        <title>Statkart print BETA</title>
    </head>
    <body>
        <div style="height:100%;width:100%">
            NB: Dette er en betatest, feil kan forekomme! Sjøkart skal bare brukes i tillegg til eksisterende navigasjonsutstyr. <br/>
<form method="get" action="statkartutsktift.html">
Kart: <select name="map">
        <option value="toporaster3">Topografisk</option>
        <option value="sjo_hovedkart2">Sjøkart</option>
        </select>
Ark: <select id="paperSize" oninput="changePaper(this.value)" name="paper">
            <option value="A3Landscape">A3 liggende</option>
            <option value="A3">A3 stående</option>
            <option value="A4Landscape" selected>A4 liggende</option>
            <option value="A4">A4 stående</option>
        </select>
    UTM sone: <select oninput="updateUTM()" id="selectUTM">
        <option value="auto">auto</option>
        <option value="32">32</option>
        <option value="33">33</option>
        <option value="35">35</option>
        </select><input type="hidden" id="UTM" name="UTM" value="32"/>
<input type="hidden" id="east" name="x"  step="any" value=557000></input>
<input type="hidden" id="north" name="y"  step="any"     value=7037000></input>
<input type="hidden" id="eastCenter"  value=566626></input>
<input type="hidden" id="northCenter" value=7029849></input>
Målestokk 1:<input type="text" name="resolution" id="resolution" step="any" value=50000 oninput="updateResolution(this.value)"></input>
Oppløsning <select name="zoom">
	<option value="13">Høy</option>
	<option value="12" selected>Middels</option>
	<option value="11">Lav</option>
</select>
<input type="hidden" id="previewZoom" value=3 />

Skygge:<input type="checkbox" name="shadow" checked></input>
Forsvarets skredkart:<input type="checkbox" name="skredForsvaret"></input>
NVEs skredkart:<input type="checkbox" name="skred"></input>
    <input type="submit" value="Gi meg kartet!"></input>
    </form>
<br/>
Det er 1 km mellom hver linje i rutenettet og ekvidistansen er 20m.
Siden er lagd for chrome, det anbefales å lagre til pdf først og så skrive ut pdfen. Husk å velg "crop to size" eller noe sånt, slik at du får rett skala når du skriver ut.

<div>
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- Statkart Print -->
    <ins class="adsbygoogle"
        style="display:inline-block;width:160px;height:600px;right: 5%;
        position: absolute;"
        data-ad-client="ca-pub-0796409597904944"
        data-ad-slot="7035529696"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
<div id="mapcontainer" style="width:70%;height:80%;top:100px;left:5%;position:absolute;">
<div id="box" style="position:absolute;top:240px;bottom:240px;left:240px;right:240px;border: 1px black solid;z-index: 800;pointer-events:none;"></div>
</div>
</div>

</div>
<script>

    Proj4js.defs["EPSG:32632"] = "+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
    Proj4js.defs["EPSG:32633"] = "+proj=utm +zone=33 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
    Proj4js.defs["EPSG:32634"] = "+proj=utm +zone=34 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
    Proj4js.defs["EPSG:32635"] = "+proj=utm +zone=35 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
    Proj4js.defs["EPSG:32636"] = "+proj=utm +zone=36 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
    Proj4js.defs["EPSG:4326"]   = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";

var map = null;
var utm = $("#UTM")[0].value;
var projection = null;
var projectionWGS84 = new OpenLayers.Projection("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs");

var resolution = parseInt($("#resolution")[0].value);
var paperWidth = .420;
var paperHeight = .297;
var mapHeight = $("#mapcontainer").height();
var mapWitdth = $("#mapcontainer").width();

function changePaper(paper) {
    if (paper == "A3Landscape"){
        paperWidth = .420;
        paperHeight = .297;
    } else if (paper == "A3"){
        paperWidth = .297;
        paperHeight = .420;
    } else if (paper == "A4Landscape") {
        paperWidth = .297;
        paperHeight = .210;
    } else if (paper == "A4") {
        paperWidth = .210;
        paperHeight = .297;
    }
    updateSquare();

}


function getCenterPosition(){
    return map.getLonLatFromPixel(new OpenLayers.Pixel(mapWitdth/2,mapHeight/2));
}

function updateResolution(newResolution) {
    resolution = parseInt(newResolution);
    updateSquare();
}

function updateSquare(){
    var center =getCenterPosition();
    var dx = paperWidth/2*resolution;
    var left = center.lon-dx;
    var right = center.lon+dx;
    var dy = paperHeight/2*resolution;
    var top = center.lat+dy;
    var bottom = center.lat-dy;
    loc =  map.getPixelFromLonLat(new OpenLayers.LonLat(left,top));
    var left = loc.x;
    var top = loc.y;
    loc =  map.getPixelFromLonLat(new OpenLayers.LonLat(right,bottom));
    var right = loc.x;
    var bottom = loc.y;
    var height = bottom-top;
    var width = right-left;

    var box = $("#box")[0];
    box.style.top = top + "px";
    box.style.left = left + "px";
    box.style.width = width + "px";
    box.style.height = height + "px";
    updateLocation();
}

function updateLocation(){
    var box = $("#box")[0];
    var y = parseInt(box.style.top);
    var x = parseInt(box.style.left);
    var loc = map.getLonLatFromPixel(new OpenLayers.Pixel(x,y));
    $("#east")[0].value = loc.lon;
    $("#north")[0].value = loc.lat;
    var center = getCenterPosition();
    $("#eastCenter")[0].value = center.lon;
    $("#northCenter")[0].value = center.lat;
    var newUTM = getBestUtm();
    if (newUTM != utm)
    {
        updateUTM();
    }

}

function getUtm(){
    return $("#UTM")[0].value;
}

function getProjection(utm){
    map.projection = "EPSG:326"+utm;
    return new OpenLayers.Projection(map.projection)

}

function getBestUtm(){
    if ($('#selectUTM')[0].value != "auto"){
        return $('#selectUTM')[0].value;
    }
    center = getCenterPosition();
    var latlon = [0,0];
    UTMXYToLatLon(center.lon,center.lat,getUtm(),false,latlon);

    east = latlon[1]*180/pi;
    if (east < 12){
        return 32;
    } else if (east < 21){
        return 33;
    } else {
        return 35;
    }
}

function onZoom(){
    $('#previewZoom')[0].value = map.zoom;
    updateSquare();
}

function addMap(center,zoom){
var div = document.createElement("div");
div.id = "mapPreview";
$("#mapcontainer").append(div);
map = new OpenLayers.Map('mapPreview');
var utm = getUtm();
projection = getProjection(utm);
map.displayProjection = projection;
if (utm == 32){
	map.maxExtent = new OpenLayers.Bounds(-2000000,	3500000,	3545984,	9045984);
} else if (utm ==33 ){
	map.maxExtent = new OpenLayers.Bounds(-2500000,	3500000,	3045984,	9045984);
} else if (utm ==34 ){
	map.maxExtent = new OpenLayers.Bounds(-3000000,	3500000,	2545984,	9045984);
} else if (utm ==35 ){
	map.maxExtent = new OpenLayers.Bounds(-3500000,	3500000,	2045984,	9045984);
} else if (utm ==36 ){
	map.maxExtent = new OpenLayers.Bounds(-4000000,	3500000,	1545984,	9045984);
}
//map.resolutions = [1800,900,450,225,120,50,25,10,4.5,3,2,1,0.5];
map.tileSize = new OpenLayers.Size(256, 256);
var ign = new OpenLayers.Layer.WMS( "Topo2",
                                   "http://opencache.statkart.no/gatekeeper/gk/gk.open", {layers: 'topo2'},{attribution:"&copy; <a href='http://www.statkart.no/'>Kartverket</a>"} );

map.addLayer(ign);

map.setCenter(center,zoom,false,false);
                                   map.events.register("zoomend",null,onZoom);
                                   map.events.register("move",null,updateLocation);
                                   updateSquare();
}

function updateUTM(){
    oldUtmZone = getUtm();
    utm = getBestUtm();
    $("#UTM")[0].value = utm;
    newProjection = getProjection(utm);
    var center = getCenterPosition();
    var zoom = map.getZoom();
    var latlon = [0,0];
    UTMXYToLatLon(center.lon,center.lat,oldUtmZone,false,latlon);
    var xy = [0,0];
    LatLonToUTMXY (latlon[0], latlon[1], utm, xy);
    center.lon = xy[0];
    center.lat = xy[1];
    $("#mapPreview").remove();
    addMap(center,zoom);
}

addMap(new OpenLayers.LonLat($('#eastCenter')[0].value,$('#northCenter')[0].value),$('#previewZoom')[0].value);
changePaper($('#paperSize')[0].value);


  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-38807768-1', 'ntnu.no');
  ga('send', 'pageview');

</script>
    </body>
</html>
